generator client {
  provider = "prisma-client"
  output   = "generated/prisma-client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          Int    @id @default(autoincrement())
  firstName   String
  lastName    String
  password    String
  phoneNumber String @unique
  email       String @unique
  cpf         String @unique

  birthDate DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role UserRole @default(user)

  consultations Consultation[]
  referrals     Referral[]
}

enum UserRole {
  user
}

model Consultation {
  id       Int    @id @default(autoincrement())
  userId   Int
  doctorId Int
  notes    String
  location String

  date      DateTime
  endTime   DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  status   ConsultationStatus @default(scheduled)
  type     ConsultationType @default(routine)

  referrals Referral[]
  doctor    Doctor     @relation(fields: [doctorId], references: [id])
  user      User       @relation(fields: [userId], references: [id])
}

enum ConsultationStatus {
  scheduled
  completed
  cancelled
  no_show
}

enum ConsultationType {
  return_visit
  exam
  routine
  checkup
}

model Doctor {
  id            Int            @id @default(autoincrement())
  firstName     String
  lastName      String
  speciality    String
  phoneNumber   String         @unique
  email         String         @unique
  password      String
  crm           String         @unique
  cpf           String         @unique

  role          DoctorRole     @default(doctor)

  birthDate     DateTime
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  consultations Consultation[]
  referralsMade     Referral[] @relation("ReferralReferredBy")
  referralsReceived Referral[] @relation("ReferralReferredTo")
}

enum DoctorRole {
  doctor
  admin
}

model Referral {
  id             Int            @id @default(autoincrement())
  consultationId Int
  userId         Int
  referredById   Int
  referredToId   Int
  reason         String
  notes          String
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  status         ReferralStatus @default(pending)
  
  consultation   Consultation   @relation(fields: [consultationId], references: [id])
  user           User           @relation(fields: [userId], references: [id])
  referredBy     Doctor         @relation("ReferralReferredBy", fields: [referredById], references: [id])
  referredTo     Doctor         @relation("ReferralReferredTo", fields: [referredToId], references: [id])
}

enum ReferralStatus {
  pending
  completed
  cancelled
}
